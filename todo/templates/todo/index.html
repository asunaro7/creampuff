<!-- /todo/templates/todo/index.html -->
{% load static %}
<head>
  <title>RPGタスク</title>
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <script src="https://cdn.jsdelivr.net/npm/uikit@3.5.5/dist/js/uikit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/uikit@3.5.5/dist/js/uikit-icons.min.js"></script>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-uWxY/CJNBR+1zjPWmfnSnVxwRheevXITnMqoEIeG1LJrdI0GlVs/9cVSyPYXdcSF" crossorigin="anonymous">

  <style>
    body{
      background-color: #f3ebdd;
    }
    html * {
      box-sizing: border-box;       /*内部要素すべてに摘要*/
    }
    h2 {
      color: blue;
      margin-left: 20px;
    }
    .todo-Upperblock{
      margin: 20px 20px 0 20px;     /*上、右、下、左*/
      width: 100vw;
      height: auto;
      background-color: #c0c0c0;
    }
    .todo-gameblock{
      position: relative;
      margin: 20px 20px 0 0;     /*上、右、下、左*/
      width: 100vw;
      height: 200px;
      background-color: #c0c0c0;
      background-repeat:repeat-x;
      background-image: url(/media/images/モンスター森背景.jpg);       /*内部要素すべてに摘要*/
    }
    .todo-telopblock{
      color: white;
    }
    .todo-animeComment{
      position: absolute;
      top: 50px;
      left: calc(50% - 70px);
      color: yellow;
      visibility: hidden;
    }
    .todo-animeComment1{
      position: absolute;
      top: 80px;
      left: calc(50% - 90px);
      color: yellow;
      visibility: hidden;
    }
    .todo-animeComment2{
      position: absolute;
      top: 80px;
      left: calc(50% + 70px);
      color: yellow;
      visibility: hidden;
    }
    .todo-animeComment3{
      position: absolute;
      top: 150px;
      left: calc(50% - 110px);
      color: yellow;
      visibility: hidden;
    }
    .todo-enemyChar{
      position: absolute;
      top: 70px;
      left: calc(50% - 80px);
      visibility: hidden;
    }
    .todo-tasktitleblock{
      display: flex;                /*内部要素の横並び*/
      margin: 20px 20px 0 20px;     /*上、右、下、左*/
    }
    .todo-tasktitle{
      width: 50vw;
      margin: 20px 20px 0 0;     /*上、右、下、左*/
    }
    .todo-todaymessageblock{
      text-align: right;
      width: 50vw;
      margin: 20px 20px 0 0;     /*上、右、下、左*/
    }
    .todo-taskblock{
      display: flex;                /*内部要素の横並び*/
      margin: 20px 20px 0 20px;     /*上、右、下、左*/
    }
    .todo-allitem{
      text-align: left;
      border: 1px solid #3f5170;
      width: 100vw;
      margin-right: 20px;
    }
    .todo-item{
      text-align: left;
      margin: 10px 10px 0 10px;
      padding: 10px 20px 10px 20px;
      background-color: #99ffcc;
    }
    .todo-rightblock{
      display: flex;                /*内部要素の横並び*/
      text-align: left;
      border: 1px solid #3f5170;
      width: 50vw;
      height: auto;
      margin-left: 20px;
    }
    .todo-buttonblock{
      margin: 20px 20px 0 20px;     /*上、右、下、左*/
      width: 15vw;
#      height: 20px;
#      background-color: #c0c0c0;
    }
    .todo-messageblock{
      margin: 30px 20px 0 20px;     /*上、右、下、左*/
      width: 25vw;
      height: 20px;
      background-color: #c0c0c0;
    }
    .todo-messageblock:hover{
      margin: 30px 20px 0 20px;     /*上、右、下、左*/
      width: 25vw;
      height: 20px;
      background-color: #c0c0c0;

      transform: rotate3d(1,0,0,360deg);  /* 回転 */
      transition: 2s;             /* 1秒かけて動く */
    }

    /* variables */
    $bkg: #f7f8fc;
    $l-grad-hex-100: #efeff6;
    $l-grad-rgba-100: rgba(179, 202, 226, 0.28);

    $d-grad-100: dark;

    body{
       //background: linear-gradient(318.32deg, #C3D1E4 0%, #DDE7F3 55%, #D4E0ED 100%);
        background: #e0e5ec;
        min-height: 100vh;
    }
    .wrapper{
      margin: 60px auto;
    }

    .neumorphism {
      background-color: #e0e5ec;
      //dark
      box-shadow: 9px 9px 16px rgba(163, 177, 198, 0.6), -9px -9px 16px rgba(255, 255, 255, 0.5);
      //light
      //box-shadow: 4px 2px 16px rgba(136, 165, 191, 0.48), -4px -2px 16px #FFFFFF;
    }

    .card-w{
        display: flex;
        margin-bottom: 20px;
      .card{
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 60px 30px;
        border-radius: 30px;
        position: relative;
      background: transparent;
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.2);

        .card__icon{

        }
        .card__text{
          text-align: center;
        }
      }
    }



    /* inset */
    .card.inset {
        box-shadow: inset 3px 3px 7px rgba(136, 165, 191, 0.48), inset -3px -3px 7px #FFFFFF;
        i {
            text-shadow: 1px 1px 1px #d6e1ef99, 0 0 0 #000, 1px 1px 1px #d6e1ef00;
        }
    }

    .card.active {
        box-shadow: 9px 9px 16px rgba(163, 177, 198, 0.6),
          -9px -9px 16px rgba(255, 255, 255, 0.5),
           inset 3px 3px 7px rgba(136, 165, 191, 0.48),
          inset -3px -3px 7px #FFFFFF;
        background: linear-gradient(318.32deg, rgba(163, 177, 198, 0.1) 0%, rgba(163, 177, 198, 0.1) 55%, rgba(163, 177, 198, 0.25) 100%);
    }

    a.title{
      color:#258039;
      text-decoration:none;
    }

    a.title:hover {
      color:#FF0099;
      text-decoration:none;
    }

  </style>


</head>


<body>
<!--<body onload="LoadProc();">-->


    <h2>ゲーム画面</h2>

    <div class="todo-Upperblock">
        <div class="todo-gameblock">
            {% block contents %}
                <div class="todo-telopblock">
                  現在の攻撃:{{ Player.attack }}　/　現在までの総タスク完了数:{{ Game.task_counter }}　/　現在までの総攻撃数:{{ Player.attack_sum }}<br>
                  {% if Game.task_counter > 0 %}
                  <p>
                   {{ Game.attack_name }} は {{ Game.damage_name }} に {{ Game.attack_power }} 攻撃した <br>
                   {{ Game.damage_name }} の HP は {{ Game.damage_a_hp }} になった
                  </p>
                  {% else %}
                  <p>タスクを完了しよう！！</p>
                  {% endif %}

                  {% if Game.mon %}
                  <p>{{ Game.damage_name }}は倒された！レベルが上がりました！！</p>
                  {% endif %}

                  {% if Game.pl %}
                  <p>
                    {{ Game.damage_name }}は倒されてしまった！ゲームオーバー！
                    最初の敵から一から始めよう！
                  </p>
                  {% endif %}
                </div>
            {% endblock %}
            <img class = "todo-enemyChar" id="enemyChar" src="/media/images/ドラゴン青140攻撃.png"><br>
            <div class = "todo-animeComment" id="animeComment">モンスターが現れた</div>
            <div class = "todo-animeComment1" id="animeComment1">バキ</div>
            <div class = "todo-animeComment2" id="animeComment2">バキ</div>
            <div class = "todo-animeComment3" id="animeComment3">バキ</div>
        </div>
    </div>

</body>

<!----------------------------------------<br>-->

  <div class="todo-tasktitleblock">
      <h2 class="todo-tasktitle">タスク</h2>
      <div class="todo-todaymessageblock">
          <p id="message">こんにちは！</p><br>
      </div>
      <div class="todo-messageblock">
          <p id="message2">こんにちは！</p><br>
      </div>
  </div>

  <div class="todo-buttonblock float-right">
    <div class="d-grid gap-2 mx-auto">
      <button type="button" class="btn btn-warning" onclick="openWinTask()">タスクを登録</button>
      <button type="button" class="btn btn-warning" onclick="openWinCategory()">カテゴリーの追加・削除</button>
      <button type="button" class="btn btn-warning" onclick="openWinBuyEquipment()">装備を購入</button>
      <button type="button" class="btn btn-warning" onclick="openWinDispCharData()">ステータス確認</button>
    </div>
  </div>



    {% if delete %}
    <p>delete</p>
    {% endif %}

    <div class="todo-taskblock">
        <div class="todo-allitem">

          <h2>カテゴリー</h2>

              <ul>
                  <a href="{% url 'todo:index' %}">
                      <li>トップ</li>
                  </a>
                  {% for category in category_list %}
                      <a href="{% url 'todo:todo_category' category %}">
                          <li>{{ category }}></li>
                      </a>
                  {% endfor %}
              </ul>

   {% block content %}

   {% if category %}
        <h2>カテゴリー: {{ category.title }}</h2>
    {% endif %}

    <div class="container wrapper"><!-- 追加   -->
    <div class="row"><!-- 追加   -->

    {% for todos in todo %}
        <div class="card-w col-md-4"><!-- 追加   -->
        <div class="card__icon"><!-- 追加   -->

        </div><!-- 追加   -->

        <div class="card border-dark mb-3" style="max-width: 18rem;">

        <!--<div class="todo-item">>

        <!--  ****************************************<br>-->

        <div class="card__text">
        <div class="card-header">
        {% if todos.deadline_date < now %}
           締切日:<span style="color:cf3721">{{ todos.deadline_date　}}</span> <b>締め切りをすぎています！</b><br>
        {% else %}
           締切日:<span style="color:31a9b8">{{ todos.deadline_date　}}</span><br>
        {% endif %}
        </div>

        <div class="card-body text-dark">
          <h5 class="card-title"><a class="title" href="{% url 'todo:detail' todos.pk %}"><font size="5"><b>{{ todos.title }}</b></font></a></h5>

          <div class="card__text"><!-- 追加   -->
          <p class="card-text">カテゴリー:{{　todos.category　}}<br>
          難易度：{{　todos.level　}}<br>
          タスクNO：<span name="todosNo">{{　todos.pk　}}<br>
          </div><!-- 追加   -->
        </div>
        </div>

        <form method="POST" action="{% url 'todo:delete' todos.pk %}">
            {% csrf_token %}
            <input type="submit" name="deleteBtn"
              value="削除"
              onclick="return confirm('本当に削除しますか？');"
            >
        </form>
        <form method="POST" action="{% url 'todo:encount' todos.pk %}">
            {% csrf_token %}
            <button type="submit" name="compBtn"><span style="color:red">完了</span></button>
        </form>
        <!--  ****************************************<br> -->
         </div>
         <!-- </div>
         </div><!-- 追加   -->

    {% endfor %}

    </div><!-- 追加   -->
    </div><!-- 追加   -->

  {% endblock %}
  </div>
  </div>

<script>
var myWindow,myWindow2,myWindow3,myWindow4;

function openWinTask() {
  myWindow = window.open("{% url 'todo:new' %}",'_blank');
}
function openWinBuyEquipment() {
  //myWindow2 = window.open("{% url 'todo:weapurchase' %}",'_blank');
  myWindow2 = window.open("{% url 'todo:weapurchase' %}", "myWindow6", "top=200,left=200,width=600,height=450");
}
function openWinDispCharData() {
  myWindow3 = window.open("dispCharData", "myWindow7", "top=200,left=200,width=600,height=450");
}
function openWinCategory() {
  myWindow4 = window.open("{% url 'todo:new_c' %}",'_blank');
}

/*上段メッセージ*/
var now = new Date();
var elm = document.getElementById('message');                                   /*１箇所*/
var elm2 = document.getElementById('message2');                                 /*１箇所*/
var hour = now.getHours();
elm.style.background = '#ffcccc';

if (hour < 2){
  elm.textContent = '健康も大事です、もうそろそろお休みになってはいかがでしょうか';
} else if(hour > 22){
  elm.textContent = '遅くまでがんばっているね、お疲れ様です。';
} else if(hour < 12){
  elm.textContent = '今日も一日頑張ろう！';
} else if(hour < 18){
  elm.textContent = 'こんにちは！';
} else{
  elm.textContent = 'こんばんは！';
}
/****************/
/*下段メッセージ*/
var startBtnElement = document.getElementById("startBtn");
var compBtnElements = document.getElementsByName("compBtn");                          /*数箇所*/
var delBtnElements = document.getElementsByName("deleteBtn");                          /*数箇所*/
var enemyCharElement = document.getElementById('enemyChar');
var animeCommentElement = document.getElementById('animeComment');
var animeCommentElement1 = document.getElementById('animeComment1');
var animeCommentElement2 = document.getElementById('animeComment2');
var animeCommentElement3 = document.getElementById('animeComment3');
var deadlineMsgElements = document.getElementsByName("deadlineMsg");                          /*数箇所*/
var todosNoElements = document.getElementsByName("todosNo");                          /*数箇所*/
var storage = localStorage;
var d = 0;s = 1;cnt = 0;
var x = 10; y = -10;
/****************/
/*完了ボタンでのメッセージ表示後一定時間（3秒）後のメッセージ表示*/
var fn = function(){
    elm2.textContent = 'やればできる！君ならできる！';
};
/****************/
/*完了ボタン後一定時間（10秒）後にアニメ表示フラグ落とす処理*/
var fn22 = function(){
    storage.completeFlg = 0;
};
/****************/
/*締切日時過ぎのアニメ処理の一定時間後のアニメ表示フラグ落とす処理*/
var fn32 = function(){
    storage.completeFlg = 0;
};
/****************/
/*完了ボタン後あなたの攻撃アニメ表示処理(モンスターhp<=0、倒され飛んでいく時)*/
var fn20 = function(){
    cnt = cnt + 1;
    if (cnt <= 20){
    }else if (cnt <= 50){
        s = 1.5 - s;
        x = -x;y = -y;
        enemyCharElement.style.transform = "translate(" + x + "px," + y + "px) scale(" + s + "," + s + ")";
        animeCommentElement.textContent = 'あなたの攻撃！';
        animeCommentElement1.textContent = "バキ";
        animeCommentElement2.textContent = "バキ";
        animeCommentElement3.textContent = "バキ";
        if(cnt % 2 == 1){
            animeCommentElement.style.visibility = "visible";
            animeCommentElement1.style.visibility = "visible";
            animeCommentElement2.style.visibility = "visible";
            animeCommentElement3.style.visibility = "visible";
        }else{
            animeCommentElement.style.visibility = "hidden";
            animeCommentElement1.style.visibility = "hidden";
            animeCommentElement2.style.visibility = "hidden";
            animeCommentElement3.style.visibility = "hidden";
        }
    }else if (cnt <= 80){
        d = d + 90;
        if (s > 0) s = s - 0.03;
        x = x + 20;y = y - 12;
        enemyCharElement.style.transform = "translate(" + x + "px," + y + "px) rotate(" + d + "deg) scale(" + s + "," + s + ")";
        animeCommentElement.remove();
        animeCommentElement1.remove();
        animeCommentElement2.remove();
        animeCommentElement3.remove();
    }else{
        enemyCharElement.remove();
    }
}
/****************/
/*完了ボタン後あなたの攻撃アニメ表示処理(モンスターhp＞0、攻撃されただけの時)*/
var fn21 = function(){
    cnt = cnt + 1;
    if (cnt <= 20){
    }else if (cnt <= 50){
        s = 1.5 - s;
        x = -x;y = -y;
        enemyCharElement.style.transform = "translate(" + x + "px," + y + "px) scale(" + s + "," + s + ")";
        animeCommentElement.textContent = 'あなたの攻撃！';
        animeCommentElement1.textContent = "バキ";
        animeCommentElement2.textContent = "バキ";
        animeCommentElement3.textContent = "バキ";
        if(cnt % 2 == 1){
            animeCommentElement.style.visibility = "visible";
            animeCommentElement1.style.visibility = "visible";
            animeCommentElement2.style.visibility = "visible";
            animeCommentElement3.style.visibility = "visible";
        }else{
            animeCommentElement.style.visibility = "hidden";
            animeCommentElement1.style.visibility = "hidden";
            animeCommentElement2.style.visibility = "hidden";
            animeCommentElement3.style.visibility = "hidden";
        }
    }else{
      animeCommentElement.remove();
      animeCommentElement1.remove();
      animeCommentElement2.remove();
      animeCommentElement3.remove();
        enemyCharElement.remove();
    }
}
/****************/
/*締切日時過ぎでのアニメ処理*/
var fn30 = function(){
    cnt = cnt + 1;
    if (cnt <= 20){
    }else if (cnt <= 32){
        console.log("103_fn30:cnt:"+cnt+":x:"+x+" y:"+y);
        d = d + 90;
        s = s + 0.03;
        x = x + 20;y = y - 12;
        enemyCharElement.style.transform = "translate(" + x + "px," + y + "px) rotate(" + d + "deg) scale(" + s + "," + s + ")";
    }else if (cnt <= 38 ){
        console.log("103_fn30:cnt:"+cnt+":x:"+x+" y:"+y);
        s = s + 0.06;
        x = x - 40;y = y + 24;
        enemyCharElement.style.transform = "translate(" + x + "px," + y + "px) rotate(" + d + "deg) scale(" + s + "," + s + ")";
        animeCommentElement.style.visibility = "visible";
  }else if (cnt <= 50 ){
      console.log("103_fn30:cnt:"+cnt+":x:"+x+" y:"+y);
      animeCommentElement.textContent = 'サキュパスの攻撃！';
      animeCommentElement1.textContent = "ドスン";
      animeCommentElement2.textContent = "ドスン";
      animeCommentElement3.textContent = "ドスン";
      if(cnt % 2 == 1){
          s = s - 1.0;
          x = x + 40;y = y - 24;
          enemyCharElement.style.transform = "translate(" + x + "px," + y + "px) rotate(" + d + "deg) scale(" + s + "," + s + ")";
          animeCommentElement.style.visibility = "visible";
          animeCommentElement1.style.visibility = "visible";
          animeCommentElement2.style.visibility = "visible";
          animeCommentElement3.style.visibility = "visible";
      }else{
          s = s + 1.0;
          x = x - 40;y = y + 24;
          enemyCharElement.style.transform = "translate(" + x + "px," + y + "px) rotate(" + d + "deg) scale(" + s + "," + s + ")";
          animeCommentElement.style.visibility = "hidden";
          animeCommentElement1.style.visibility = "hidden";
          animeCommentElement2.style.visibility = "hidden";
          animeCommentElement3.style.visibility = "hidden";
      }
    }else {
        enemyCharElement.remove();
        animeCommentElement.remove();
        animeCommentElement1.remove();
        animeCommentElement2.remove();
        animeCommentElement3.remove();
    }
}

/****************/
/*完了ボタン締切チェック（締切メッセージ有無）処理*/
for (let i = 0; i < compBtnElements.length; i++) {
    console.log("102_msgFlg2:"+storage.msgFlg2);
    compBtnElements[i].addEventListener('click', function() {
        storage.completeFlg = 1;
        storage.msgFlg2 = i;
    }, false);
}



console.log("101_len:"+storage.length);
/****************/
/*完了ボタンクリック後のアニメ表示処理(fn20)、消去処理(fn22)*/
for (let i = 0; i < compBtnElements.length; i++) {
  console.log("103_deadlineMsgElements[i].textContent:"+i+":"+deadlineMsgElements[i].textContent);
}
if (storage.completeFlg == 1){
    console.log("103_storage.msgFlg2:"+storage.msgFlg2);

    if ( {{ Game.deadlineFlg}} == 1 ){

        elm2.textContent = '残念だったけどよく頑張ったね！';
        var timer1 = setTimeout(fn, 3000);
        console.log("105_msgFlg2:"+storage.msgFlg2);
        storage.msgFlg2 = 99;

        enemyCharElement.style.visibility = "visible";
        animeCommentElement.style.visibility = "visible";
        var timer2 = setInterval(fn30, 100);
        var timer3 = setTimeout(fn32, 10000);

    }else{


        elm2.textContent = 'やったね！';
        var timer1 = setTimeout(fn, 3000);
        console.log("106_msgFlg2:"+storage.msgFlg2);
        storage.msgFlg2 = 99;

        enemyCharElement.style.visibility = "visible";
        animeCommentElement.style.visibility = "visible";

        if ( {{ Game.damage_a_hp }} > 0 ){
            console.log("107_msgFlg2:"+storage.msgFlg2);
            var timer2 = setInterval(fn21, 100);
            var timer3 = setTimeout(fn22, 10000);
        }else{
            console.log("108_msgFlg2:"+storage.msgFlg2);
            var timer2 = setInterval(fn20, 100);
            var timer3 = setTimeout(fn22, 10000);
        }
    }

}
console.log("120_msgFlg2:"+storage.msgFlg2);
console.log("120_completeFlg:"+storage.completeFlg);
if (storage.completeFlg == 0){
    enemyCharElement.style.visibility = "hidden";
    animeCommentElement.style.visibility = "hidden";
    animeCommentElement1.style.visibility = "hidden";
    animeCommentElement2.style.visibility = "hidden";
    animeCommentElement3.style.visibility = "hidden";
}

</script>
